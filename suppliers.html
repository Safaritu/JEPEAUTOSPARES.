<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suppliers & Logistics | JEPE ADMIN</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --admin-dark: #1e293b;
            --admin-accent: #6366f1;
            --bg: #f8fafc;
            --white: #ffffff;
            --text: #1e293b;
            --text-dim: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --orange: #f59e0b;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); margin: 0; color: var(--text);
            display: flex; overflow-x: hidden; min-height: 100vh;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; left: -260px; top: 0; width: var(--sidebar-width);
            height: 100vh; background: var(--admin-dark); z-index: 2000;
            padding: 25px; display: flex; flex-direction: column;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: white;
        }
        @media (min-width: 1024px) {
            .sidebar { left: 0; }
            .main-wrapper { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
            .mobile-header { display: none !important; }
        }
        .sidebar.active { left: 0; }

        .nav-link {
            display: flex; align-items: center; padding: 12px 15px;
            color: #94a3b8; text-decoration: none; font-weight: 600;
            border-radius: 10px; margin-bottom: 5px; transition: 0.2s; font-size: 0.9rem;
        }
        .nav-link.active { background: var(--admin-accent); color: white; }

        /* --- MAIN LAYOUT --- */
        .main-wrapper { width: 100%; }
        .mobile-header {
            background: var(--admin-dark); color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }

        .container { padding: 20px; max-width: 1200px; margin: auto; }

        /* --- STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { 
            background: var(--white); padding: 20px; border-radius: 16px; 
            border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border-left: 5px solid var(--admin-accent);
        }
        .stat-card h4 { margin: 0; color: var(--text-dim); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        .stat-card p { margin: 8px 0 0; font-size: 1.4rem; font-weight: 800; }

        /* --- CARDS & TABLES --- */
        .card { 
            background: var(--white); border-radius: 20px; border: 1px solid var(--border); 
            padding: 24px; margin-bottom: 25px; 
        }
        .table-container { width: 100%; overflow-x: auto; border-radius: 12px; border: 1px solid #f1f5f9; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { text-align: left; padding: 14px; background: #f8fafc; font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); font-weight: 800; }
        td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }

        /* --- BUTTONS --- */
        .btn { padding: 10px 18px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; font-size: 0.75rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--admin-accent); color: white; }
        .btn-pay { background: var(--orange); color: white; }
        .btn-order { background: var(--admin-dark); color: white; }
        .btn-load { width: 100%; background: #f1f5f9; color: var(--text-dim); margin-top: 10px; }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 0.7rem; }
        .bg-debt { background: #fee2e2; color: #991b1b; }
        .bg-clear { background: #dcfce7; color: #166534; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 3000; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal label { font-size: 0.7rem; font-weight: 800; color: var(--text-dim); display: block; margin-top: 15px; margin-bottom: 5px; }
        .modal input, .modal select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-family: inherit; font-size: 1rem; outline: none; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        .overlay.active { display: block; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; }
        .section-header h3 { margin: 0; font-weight: 800; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div style="padding: 10px 0 30px 10px; font-weight: 800; font-size: 1.4rem; color:white;">JEPE ADMIN</div>
    <nav>
   <a href="admin.html" class="nav-link">üìä Dashboard view</a>
        <a href="shift-history.html" class="nav-link">üìã Daily Shift Audit</a>
        <a href="inventory.html" class="nav-link">‚ûï Add Stock</a>
        <a href="audit_trail.html" class="nav-link">üîç Track Stock Edits</a>
        <a href="sales_editor.html" class="nav-link">‚úèÔ∏è Edit Stock/Sales</a>
        <a href="sales-history.html" class="nav-link">üìú Sales History</a>
        <a href="reports.html" class="nav-link">üìÑ Detailed Reports</a>
        <a href="suppliers.html" class="nav-link">ü§ù Suppliers</a>
        <a href="gas_hub.html" class="nav-link">üî• Gas Hub</a>
        <a href="low_stock.html" class="nav-link" id="low-stock-nav">‚ö†Ô∏è Low Stock Alerts</a>
        <a href="admin-debtors.html" class="nav-link">üë• Debtors</a>
        <a href="price_audits.html" class="nav-link">üìâ Price Audits</a>
        <a href="money-history.html" class="nav-link">üìú Money History</a>
    </nav>
    <div style="margin-top: auto;">
        <a onclick="handleLogout()" class="nav-link" style="color: #fb7185; cursor:pointer;">üö™ Logout</a>
    </div>
</div>

<div class="main-wrapper">
    <div class="mobile-header">
        <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:1.5rem;">‚ò∞</button>
        <div style="font-weight:800; letter-spacing: 1px;">LOGISTICS</div>
        <div style="width:24px;"></div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card" style="border-left-color: var(--danger);">
                <h4>Total Payable (Debt)</h4>
                <p id="stat-total-debt" style="color: var(--danger);">Ksh 0</p>
            </div>
            <div class="stat-card" style="border-left-color: var(--admin-accent);">
                <h4>Paid (Digital Account)</h4>
                <p id="stat-digital-total">Ksh 0</p>
            </div>
            <div class="stat-card" style="border-left-color: var(--orange);">
                <h4>Paid (Shop Cash)</h4>
                <p id="stat-cash-total">Ksh 0</p>
            </div>
        </div>

        <div class="section-header">
            <h3>Supplier Directory</h3>
            <button class="btn btn-add" onclick="openSupplierModal()">+ New Supplier</button>
        </div>

        <div class="card">
            <input type="text" style="width:100%; padding:14px; margin-bottom:20px; border-radius:12px; border:1px solid #e2e8f0;" id="searchSupplier" placeholder="Search by name or category..." onkeyup="filterSuppliers()">
            <div class="table-container">
                <table id="supplierTable">
                    <thead>
                        <tr>
                            <th>Supplier Name</th>
                            <th>Category</th>
                            <th>Phone</th>
                            <th>Balance Owed</th>
                            <th>Quick Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section-header"><h3>Recent Stock Deliveries</h3></div>
        <div class="card">
            <div class="table-container">
                <table id="orderTable">
                    <thead>
                        <tr><th>Date</th><th>Supplier</th><th>Items/Description</th><th>Bill Amount</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-load" onclick="loadMoreOrders()">View More Deliveries</button>
        </div>

        <div class="section-header"><h3>Payment History</h3></div>
        <div class="card">
            <div class="table-container">
                <table id="paymentTable">
                    <thead>
                        <tr><th>Date</th><th>Supplier</th><th>Method</th><th>Paid Amount</th><th>Remaining</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-load" onclick="loadMorePayments()">View More Payments</button>
        </div>
    </div>
</div>

<div id="paymentModal" class="modal"><div class="modal-content">
    <h3 style="margin:0">Record Payment</h3>
    <input type="hidden" id="pay-sup-id">
    <label>SUPPLIER</label>
    <input type="text" id="pay-sup-name" readonly style="background:#f1f5f9; font-weight:800;">
    <label>PAYMENT SOURCE</label>
    <select id="pay-method">
        <option>Digital/Sales Account</option>
        <option>Shop Cash</option>
    </select>
    <label>AMOUNT TO PAY (KSH)</label>
    <input type="number" id="pay-amount" placeholder="0.00">
    <button class="btn btn-pay" onclick="processPayment()" style="width:100%; padding:15px; margin-top:20px;">Confirm Payment</button>
    <button class="btn" onclick="closeModals()" style="width:100%; margin-top:10px; background:none; color:var(--text-dim);">Close</button>
</div></div>

<div id="supplierModal" class="modal"><div class="modal-content">
    <h3 style="margin:0">Supplier Details</h3>
    <input type="hidden" id="sup-id">
    <label>COMPANY/NAME</label>
    <input type="text" id="sup-name" placeholder="Enter supplier name">
    <label>BUSINESS CATEGORY</label>
    <select id="sup-category">
        <option>Spare Parts</option><option>Gas</option><option>Tyres</option><option>Oil/Lubricants</option><option>General</option>
    </select>
    <label>CONTACT PHONE</label>
    <input type="text" id="sup-phone" placeholder="07xx xxx xxx">
    <label>CURRENT BALANCE (KSH)</label>
    <input type="number" id="sup-balance" value="0">
    <button class="btn btn-add" onclick="saveSupplier()" style="width:100%; padding:15px; margin-top:20px;">Save Supplier</button>
    <button class="btn" onclick="closeModals()" style="width:100%; margin-top:10px; background:none; color:var(--text-dim);">Cancel</button>
</div></div>

<div id="orderModal" class="modal"><div class="modal-content">
    <h3 style="margin:0">Receive Delivery</h3>
    <input type="hidden" id="order-sup-id">
    <label>SUPPLIER</label>
    <input type="text" id="order-sup-name" readonly style="background:#f1f5f9; font-weight:800;">
    <label>WHAT WAS DELIVERED?</label>
    <input type="text" id="order-items" placeholder="e.g., 50 Spark Plugs">
    <label>TOTAL COST (KSH)</label>
    <input type="number" id="order-cost" placeholder="0.00">
    <button class="btn btn-order" onclick="saveOrder()" style="width:100%; padding:15px; margin-top:20px;">Record Stock Debt</button>
    <button class="btn" onclick="closeModals()" style="width:100%; margin-top:10px; background:none; color:var(--text-dim);">Cancel</button>
</div></div>

<script type="module">
    import { supabase } from './auth.js';

    let allSuppliers = [], allOrders = [], allPayments = [];
    let orderLimit = 10, paymentLimit = 10;

    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    };

    async function init() {
        await fetchSuppliers();
        await fetchOrders();
        await fetchPayments();
    }

    async function fetchSuppliers() {
        const { data } = await supabase.from('suppliers').select('*').order('name');
        if (data) {
            allSuppliers = data;
            const totalDebt = data.reduce((sum, s) => sum + (s.balance_owed || 0), 0);
            document.getElementById('stat-total-debt').innerText = `Ksh ${totalDebt.toLocaleString()}`;
            filterSuppliers();
        }
    }

    async function fetchOrders() {
        const { data } = await supabase.from('supplier_orders').select('*, suppliers(name)').order('order_date', {ascending:false});
        if (data) { allOrders = data; filterOrders(); }
    }

    async function fetchPayments() {
        const { data } = await supabase.from('supplier_payments').select('*, suppliers(name)').order('payment_date', {ascending:false});
        if (data) { 
            allPayments = data; 
            let digital = 0, cash = 0;
            data.forEach(p => { 
                if (p.payment_method === 'Digital/Sales Account') digital += p.amount_paid;
                else cash += p.amount_paid;
            });
            document.getElementById('stat-digital-total').innerText = `Ksh ${digital.toLocaleString()}`;
            document.getElementById('stat-cash-total').innerText = `Ksh ${cash.toLocaleString()}`;
            filterPayments();
        }
    }

    window.filterSuppliers = () => {
        const q = document.getElementById('searchSupplier').value.toLowerCase();
        const filtered = allSuppliers.filter(s => s.name.toLowerCase().includes(q) || s.category.toLowerCase().includes(q));
        document.querySelector('#supplierTable tbody').innerHTML = filtered.map(s => `
            <tr>
                <td><b>${s.name}</b></td>
                <td><span class="badge" style="background:#f1f5f9; color:var(--text-dim)">${s.category}</span></td>
                <td>${s.phone || '--'}</td>
                <td><span class="badge ${s.balance_owed > 0 ? 'bg-debt' : 'bg-clear'}">Ksh ${s.balance_owed.toLocaleString()}</span></td>
                <td>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-order" onclick="openOrderModal('${s.id}', '${s.name}')">+ Stock</button>
                        <button class="btn btn-pay" onclick="openPaymentModal('${s.id}', '${s.name}')">Pay</button>
                        <button class="btn" style="background:#f1f5f9; color:var(--admin-accent)" onclick="editSupplier('${s.id}')">‚úèÔ∏è</button>
                    </div>
                </td>
            </tr>
        `).join('');
    };

    window.filterOrders = () => {
        document.querySelector('#orderTable tbody').innerHTML = allOrders.slice(0, orderLimit).map(o => `
            <tr>
                <td><small>${new Date(o.order_date).toLocaleDateString()}</small></td>
                <td><b>${o.suppliers?.name || '---'}</b></td>
                <td>${o.items_brought}</td>
                <td style="font-weight:800;">Ksh ${o.cost.toLocaleString()}</td>
            </tr>
        `).join('');
    };

    window.filterPayments = () => {
        document.querySelector('#paymentTable tbody').innerHTML = allPayments.slice(0, paymentLimit).map(p => `
            <tr>
                <td><small>${new Date(p.payment_date).toLocaleDateString()}</small></td>
                <td><b>${p.suppliers?.name || '---'}</b></td>
                <td><span class="badge" style="background:#e0f2fe; color:#0369a1">${p.payment_method}</span></td>
                <td style="color:var(--success); font-weight:800;">Ksh ${p.amount_paid.toLocaleString()}</td>
                <td style="color:var(--danger); font-weight:800;">Ksh ${p.balance_after.toLocaleString()}</td>
            </tr>
        `).join('');
    };

    window.loadMoreOrders = () => { orderLimit += 10; filterOrders(); };
    window.loadMorePayments = () => { paymentLimit += 10; filterPayments(); };

    window.openPaymentModal = (id, name) => {
        document.getElementById('pay-sup-id').value = id;
        document.getElementById('pay-sup-name').value = name;
        document.getElementById('paymentModal').style.display = "flex";
    };

    window.openSupplierModal = () => {
        document.getElementById('sup-id').value = "";
        document.getElementById('sup-name').value = "";
        document.getElementById('sup-balance').value = 0;
        document.getElementById('sup-phone').value = "";
        document.getElementById('supplierModal').style.display = "flex";
    };

    window.openOrderModal = (id, name) => {
        document.getElementById('order-sup-id').value = id;
        document.getElementById('order-sup-name').value = name;
        document.getElementById('orderModal').style.display = "flex";
    };

    window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = "none");

    window.saveSupplier = async () => {
        const id = document.getElementById('sup-id').value;
        const payload = {
            name: document.getElementById('sup-name').value,
            category: document.getElementById('sup-category').value,
            phone: document.getElementById('sup-phone').value,
            balance_owed: parseFloat(document.getElementById('sup-balance').value) || 0
        };
        const { error } = id ? await supabase.from('suppliers').update(payload).eq('id', id) : await supabase.from('suppliers').insert([payload]);
        if (error) alert(error.message); else { closeModals(); init(); }
    };

    window.saveOrder = async () => {
        const sid = document.getElementById('order-sup-id').value;
        const items = document.getElementById('order-items').value;
        const cost = parseFloat(document.getElementById('order-cost').value) || 0;
        if(cost <= 0) return alert("Please enter cost");

        await supabase.from('supplier_orders').insert([{ supplier_id: sid, items_brought: items, cost: cost }]);
        const supplier = allSuppliers.find(x => x.id === sid);
        await supabase.from('suppliers').update({ balance_owed: (supplier.balance_owed || 0) + cost }).eq('id', sid);
        closeModals();
        init();
    };

    window.processPayment = async () => {
        const sid = document.getElementById('pay-sup-id').value;
        const amount = parseFloat(document.getElementById('pay-amount').value);
        const method = document.getElementById('pay-method').value;
        if(!amount || amount <= 0) return alert("Enter valid amount");

        const supplier = allSuppliers.find(x => x.id === sid);
        const newBalance = (supplier.balance_owed || 0) - amount;
        
        await supabase.from('suppliers').update({ balance_owed: newBalance }).eq('id', sid);
        await supabase.from('supplier_payments').insert([{
            supplier_id: sid, amount_paid: amount, balance_before: supplier.balance_owed,
            balance_after: newBalance, payment_method: method
        }]);
        closeModals();
        init();
    };

    window.editSupplier = (id) => {
        const s = allSuppliers.find(x => x.id === id);
        document.getElementById('sup-id').value = s.id;
        document.getElementById('sup-name').value = s.name;
        document.getElementById('sup-category').value = s.category;
        document.getElementById('sup-phone').value = s.phone;
        document.getElementById('sup-balance').value = s.balance_owed;
        document.getElementById('supplierModal').style.display = "flex";
    };

    window.handleLogout = async () => {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    };

    init();
</script>
</body>
</html>