<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JEPE POS | Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; --primary-dark: #3730a3;
            --bg: #f1f5f9; --card-bg: #ffffff; 
            --danger: #e11d48; --success: #10b981; --warning: #f59e0b;
            --nav-btn-bg: #6366f1; --text-main: #1e293b; --text-dim: #64748b;
            --border: #e2e8f0; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); padding: 10px; margin: 0; color: var(--text-main); line-height: 1.5; overflow-x: hidden; width: 100%; }
        .container { max-width: 1450px; margin: auto; width: 100%; }
        header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; padding: 20px; background: #fff; border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        @media (min-width: 768px) { header { flex-direction: row; justify-content: space-between; align-items: center; } }
        .logo { font-size: 1.4rem; font-weight: 800; letter-spacing: -1px; color: #111827; }
        .logo span { color: var(--primary); font-weight: 500; font-size: 0.9rem; margin-left: 5px; opacity: 0.8; }
        .float-status-card { background: #fff; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (min-width: 600px) { .float-status-card { grid-template-columns: repeat(5, 1fr); } }
        .float-item { text-align: center; }
        .float-item label { display: block; font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; font-weight: 800; }
        .float-item span { font-size: 1.1rem; font-weight: 800; color: var(--primary); }
        .card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .section-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--primary); margin-bottom: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .section-label::after { content: ""; flex: 1; height: 1px; background: var(--border); }
        .grid-inputs { display: grid; gap: 15px; }
        .input-group { display: flex; flex-direction: column; }
        label { margin-bottom: 6px; font-weight: 700; color: var(--text-main); font-size: 0.75rem; }
        input, select { background: #f8fafc; border: 1px solid var(--border); padding: 14px; border-radius: 12px; font-size: 16px; width: 100%; }
        .btn { padding: 16px 24px; border-radius: 12px; font-weight: 800; cursor: pointer; border: none; transition: 0.3s; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(8px); padding: 20px; }
        .modal { background: #fff; padding: 25px; border-radius: 24px; width: 100%; max-width: 500px; }
        .menu-fab { position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); cursor: pointer; z-index: 5000; border: 4px solid white; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 90%; max-width: 450px; }
        .menu-item { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 18px; color: white; text-decoration: none; text-align: center; font-weight: 700; }
        .table-card { background: #fff; border: 1px solid var(--border); border-radius: 16px; overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 15px; background: #f8fafc; text-align: left; font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="menu-fab" onclick="toggleFullMenu()">‚ò∞</div>
<div class="menu-overlay" id="full-menu">
    <div class="close-menu" onclick="toggleFullMenu()" style="color:white; position:absolute; top:30px; right:30px; font-size:2rem; cursor:pointer;">‚úï</div>
    <div class="menu-grid">
        <a href="cashiergashub.html" class="menu-item">‚õΩ Gas Hub</a>
        <a href="low-stock-cashier.html" class="menu-item">‚ö†Ô∏è Low Stock</a>
        <a href="debtors.html" class="menu-item">üë• Debtors</a>
        <a href="#" onclick="logoutUser()" class="menu-item" style="background:var(--danger); grid-column: span 2;">üö™ Log Out</a>
    </div>
</div>

<div class="container">
    <header>
        <div class="logo">JEPE POS <span>/ Terminal</span></div>
        <div id="shift-action-container"></div>
    </header>

    <div class="section-label">Opening Wallet Balances</div>
    <div class="float-status-card">
        <div class="float-item"><label>Cash</label><span id="float-cash">0</span></div>
        <div class="float-item"><label>Mpesa</label><span id="float-mpesa">0</span></div>
        <div class="float-item"><label>KCB Paybill</label><span id="float-kcb">0</span></div>
        <div class="float-item"><label>Equity</label><span id="float-equity">0</span></div>
        <div class="float-item"><label>KCB Bank</label><span id="float-bank">0</span></div>
    </div>

    <div class="card">
        <form id="sale-form">
            <div class="grid-inputs" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                <div class="input-group">
                    <label>Search Item</label>
                    <input type="text" id="pSearch" list="pList" placeholder="Find Item..." required>
                    <datalist id="pList"></datalist>
                </div>
                <div class="input-group"><label>Price (Ksh)</label><input type="number" id="pPrice" step="0.01" required></div>
                <div class="input-group"><label>Qty</label><input type="number" id="pQty" value="1" min="1"></div>
                <div class="input-group">
                    <label>Method</label>
                    <select id="pMethod" onchange="toggleSplitFields()">
                        <option value="Cash">Cash (Shop)</option>
                        <option value="Mpesa">KCB / Paybill</option>
                        <option value="KCB Bank">KCB Bank (Account)</option>
                        <option value="Split">Split: Cash + Paybill</option>
                        <option value="Debt">Debtor</option>
                    </select>
                </div>
            </div>
            <div id="split-fields" style="display:none; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <input type="number" id="split-cash" placeholder="Cash Amount" oninput="calculateSplit()">
                <input type="number" id="split-online" placeholder="Online Balance" readonly>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top:20px; width:100%;">RECORD Ksh <span id="total-text">0</span></button>
        </form>
    </div>

    <div class="section-label">LIVE SALES</div>
    <div class="table-card"><table id="sales-table"><thead><tr><th>Time</th><th>Item</th><th>Qty</th><th>Total</th><th>Method</th></tr></thead><tbody id="live-sales-body"></tbody></table></div>
</div>

<div id="open-modal" class="overlay">
    <div class="modal">
        <h3>üöÄ Start Shift</h3>
        <input type="number" id="o-cash" placeholder="Cash Float" style="margin-bottom:10px;">
        <input type="number" id="o-mpesa" placeholder="Mpesa Float" style="margin-bottom:10px;">
        <input type="number" id="o-kcb" placeholder="Paybill Float" style="margin-bottom:10px;">
        <input type="number" id="o-bank" placeholder="KCB Bank Balance" style="margin-bottom:10px;">
        <button class="btn btn-primary" id="confirm-open" style="width:100%">OPEN DAY</button>
    </div>
</div>

<div id="close-modal" class="overlay">
    <div class="modal">
        <h3>üîí Close Shift</h3>
        <input type="number" id="c-cash" placeholder="Actual Cash" style="margin-bottom:10px;">
        <input type="number" id="c-mpesa" placeholder="Actual Mpesa" style="margin-bottom:10px;">
        <input type="number" id="c-kcb" placeholder="Actual Paybill" style="margin-bottom:10px;">
        <input type="number" id="c-bank" placeholder="Actual KCB Bank" style="margin-bottom:10px;">
        <button class="btn btn-danger" id="confirm-close" style="width:100%">CLOSE DAY</button>
    </div>
</div>

<script type="module">
    import { supabase } from './auth.js';
    let inventory = [], currentShift = null, selectedItem = null;

    async function init() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return window.location.href = 'index.html';

        const { data: prods } = await supabase.from('products').select('*');
        inventory = prods || [];
        document.getElementById('pList').innerHTML = inventory.map(p => `<option value="${p.name}">`).join('');

        const { data: shift } = await supabase.from('daily_shifts').select('*').eq('status', 'Open').maybeSingle();
        const actionBtnContainer = document.getElementById('shift-action-container');
        if (shift) {
            currentShift = shift;
            actionBtnContainer.innerHTML = `<button class="btn btn-danger" onclick="document.getElementById('close-modal').style.display='flex'">üî¥ CLOSE DAY</button>`;
            document.getElementById('float-cash').innerText = shift.open_cash.toLocaleString();
            document.getElementById('float-bank').innerText = (shift.open_kcb_bank || 0).toLocaleString();
            loadSales();
        } else {
            actionBtnContainer.innerHTML = `<button class="btn btn-primary" onclick="document.getElementById('open-modal').style.display='flex'">üü¢ START DAY</button>`;
        }
    }

    document.getElementById('sale-form').onsubmit = async (e) => {
        e.preventDefault();
        const method = document.getElementById('pMethod').value;
        const price = parseFloat(document.getElementById('pPrice').value);
        const qty = parseInt(document.getElementById('pQty').value);
        
        // Stock management and sales logging logic remains as per original
        // Note: 'KCB Bank' sales are logged but don't touch shop cash floats
        const salesToInsert = [{
            shift_id: currentShift.id,
            item_name: document.getElementById('pSearch').value,
            quantity: qty,
            unit_price: price,
            total_amount: price * qty,
            payment_method: method
        }];

        await supabase.from('sales').insert(salesToInsert);
        location.reload();
    };

    document.getElementById('confirm-open').onclick = async () => {
        await supabase.from('daily_shifts').insert([{
            open_cash: parseFloat(document.getElementById('o-cash').value || 0),
            open_kcb_bank: parseFloat(document.getElementById('o-bank').value || 0),
            status: 'Open', start_time: new Date().toISOString()
        }]);
        location.reload();
    };

    window.toggleFullMenu = () => {
        const menu = document.getElementById('full-menu');
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    };

    init();
</script>
</body>
</html>